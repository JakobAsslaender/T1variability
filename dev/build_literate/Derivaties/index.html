<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Sensitivity analysis · T₁ variability</title><meta name="title" content="Sensitivity analysis · T₁ variability"/><meta property="og:title" content="Sensitivity analysis · T₁ variability"/><meta property="twitter:title" content="Sensitivity analysis · T₁ variability"/><meta name="description" content="Documentation for T₁ variability."/><meta property="og:description" content="Documentation for T₁ variability."/><meta property="twitter:description" content="Documentation for T₁ variability."/><meta property="og:url" content="https://JakobAsslaender.github.io/T1variability/build_literate/Derivaties/"/><meta property="twitter:url" content="https://JakobAsslaender.github.io/T1variability/build_literate/Derivaties/"/><link rel="canonical" href="https://JakobAsslaender.github.io/T1variability/build_literate/Derivaties/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">T₁ variability</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">T₁ variability</span><ul><li><a class="tocitem" href="../T1_mapping_methods/">T₁-mapping methods</a></li><li><a class="tocitem" href="../Fit_qMT_to_literatureT1/">Global fit</a></li><li><a class="tocitem" href="../helper_functions/">Helper functions</a></li></ul></li><li><span class="tocitem">T₁ sensitivity</span><ul><li class="is-active"><a class="tocitem" href>Sensitivity analysis</a><ul class="internal"><li><a class="tocitem" href="#Load-code"><span>Load code</span></a></li><li><a class="tocitem" href="#Set-parameters"><span>Set parameters</span></a></li><li><a class="tocitem" href="#Compute-derivatives"><span>Compute derivatives</span></a></li><li><a class="tocitem" href="#Figure-1"><span>Figure 1</span></a></li><li><a class="tocitem" href="#Linear-Mixed-model"><span>Linear Mixed model</span></a></li><li><a class="tocitem" href="#Table-1"><span>Table 1</span></a></li><li><a class="tocitem" href="#Table-2"><span>Table 2</span></a></li><li><a class="tocitem" href="#Figure-2"><span>Figure 2</span></a></li><li><a class="tocitem" href="#Table-A1"><span>Table A1</span></a></li></ul></li><li><a class="tocitem" href="../Derivatives_HelperFunctions/">Helper functions for the sensitivity analysis</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">T₁ sensitivity</a></li><li class="is-active"><a href>Sensitivity analysis</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Sensitivity analysis</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JakobAsslaender/T1variability" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/JakobAsslaender/T1variability/blob/master/Derivaties.jl" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Sensitivity-analysis"><a class="docs-heading-anchor" href="#Sensitivity-analysis">Sensitivity analysis</a><a id="Sensitivity-analysis-1"></a><a class="docs-heading-anchor-permalink" href="#Sensitivity-analysis" title="Permalink"></a></h1><h2 id="Load-code"><a class="docs-heading-anchor" href="#Load-code">Load code</a><a id="Load-code-1"></a><a class="docs-heading-anchor-permalink" href="#Load-code" title="Permalink"></a></h2><p>First, we load the required packages and include some <a href="../helper_functions/#Helper-functions">Helper functions</a>:</p><pre><code class="language-julia hljs">include(&quot;helper_functions.jl&quot;)
include(&quot;Derivatives_HelperFunctions.jl&quot;)</code></pre><p>load all <a href="../T1_mapping_methods/#T-mapping-methods">T₁-mapping methods</a>:</p><pre><code class="language-julia hljs">include(&quot;T1_mapping_methods.jl&quot;)</code></pre><p>All simulations in this analysis are performed with the generalized Bloch model:</p><pre><code class="language-julia hljs">MT_model = gBloch()</code></pre><h2 id="Set-parameters"><a class="docs-heading-anchor" href="#Set-parameters">Set parameters</a><a id="Set-parameters-1"></a><a class="docs-heading-anchor-permalink" href="#Set-parameters" title="Permalink"></a></h2><p>We analyze overall 9 ROIs and use the MT parameters from the paper <a href="https://doi.org/10.1162/imag_a_00177">Unconstrained quantitative magnetization transfer imaging: Disentangling T₁ of the free and semi-solid spin pools</a>:</p><pre><code class="language-julia hljs">ROI = [:WM, :anteriorCC, :posteriorCC, :GM, :caudate, :putamen, :pallidum, :thalamus, :hippocampus]
m0s = [0.212, 0.237, 0.235, 0.098, 0.113, 0.118, 0.164, 0.158, 0.097]
T1f = [1.84, 1.77, 1.80, 2.46, 1.95, 1.84, 1.664, 2.02, 2.65]
T2f = [76.9, 69.9, 76.3, 83, 73.3, 67.4, 59.3, 70.8, 91] .* 1e-3
Rex = [13.6, 13.4, 13.5, 14.0, 13.8, 14.9, 15.8, 14.2, 15.3]
T1s = [0.34, 0.349, 0.350, 0.42, 0.432, 0.385, 0.351, 0.396, 0.376]
T2s = [12.5, 14.5, 12.6, 14.4, 15.1, 15.4, 14.9, 13.0, 13.0]</code></pre><p>For consistency, we use times instead of rates throughout</p><pre><code class="language-julia hljs">Tex = 1 ./ Rex</code></pre><p>and we neglect B₀ and B₁ inhomogeneities:</p><pre><code class="language-julia hljs">ω0 = 0
B1 = 1</code></pre><p>We define vectors of symbols for all MT parameters and the derivatives ∂T₁ᵒ/∂pⱼᴹᵀ:</p><pre><code class="language-julia hljs">p = [:m0s, :T1f, :T2f, :Tex, :T1s, :T2s]
j = [:dT1odm0s, :dT1odT1f, :dT1odT2f, :dT1odTex, :dT1odT1s, :dT1odT2s]</code></pre><h2 id="Compute-derivatives"><a class="docs-heading-anchor" href="#Compute-derivatives">Compute derivatives</a><a id="Compute-derivatives-1"></a><a class="docs-heading-anchor-permalink" href="#Compute-derivatives" title="Permalink"></a></h2><p>Since the calculation of the derivatives is computationally intensive, it is pre-computed and saved in a CSV file. To recompute the derivatives, set the following parameter to <code>true</code>:</p><pre><code class="language-julia hljs">calculate_jacobian = false</code></pre><p>We store all derivatives in a <code>DataFrame</code> list (saved in the file <code>jacobian.csv</code>), concatenating ROIs and T₁ mapping methods:</p><pre><code class="language-julia hljs">Nrows = length(ROI) * length(T1_functions)

if calculate_jacobian
    df = DataFrame(
        seq_name=Vector{String}(undef, Nrows),
        seq_type=Vector{Symbol}(undef, Nrows),
        ROI=Vector{Symbol}(undef, Nrows),
        m0s=Vector{Float64}(undef, Nrows),
        T1f=Vector{Float64}(undef, Nrows),
        T2f=Vector{Float64}(undef, Nrows),
        Tex=Vector{Float64}(undef, Nrows),
        T1s=Vector{Float64}(undef, Nrows),
        T2s=Vector{Float64}(undef, Nrows),
        dT1odm0s=Vector{Float64}(undef, Nrows),
        dT1odT1f=Vector{Float64}(undef, Nrows),
        dT1odT2f=Vector{Float64}(undef, Nrows),
        dT1odTex=Vector{Float64}(undef, Nrows),
        dT1odT1s=Vector{Float64}(undef, Nrows),
        dT1odT2s=Vector{Float64}(undef, Nrows),
    )

    Threads.@threads for iROI ∈ eachindex(ROI)
        _p = (m0s[iROI], T1f[iROI], T2f[iROI], Tex[iROI], T1s[iROI], T2s[iROI])
        Threads.@threads for iseq ∈ eachindex(T1_functions)
            df_idx = iseq + length(T1_functions) * (iROI - 1)

            # The following line performs the actual computation of the derivatives.
            # `T1_functions` takes the rates of several MT parameters, so we have to call it with `1/T`.
            # `T₂ˢ` is rescaled to ensure stability of the finite difference algorithm.
            j = jacobian(central_fdm(5, 1), p -&gt; T1_functions[iseq](p[1], 1 / p[2], 1 / p[3], 1 / p[4], 1 / p[5], 1e-6p[6]), _p)[1]

            df[df_idx, :seq_name] = seq_name[iseq]
            df[df_idx, :seq_type] = seq_type[iseq]
            df[df_idx, :ROI] = ROI[iROI]
            df[df_idx, :m0s] = m0s[iROI]
            df[df_idx, :T1f] = T1f[iROI]
            df[df_idx, :T2f] = T2f[iROI]
            df[df_idx, :Tex] = Tex[iROI]
            df[df_idx, :T1s] = T1s[iROI]
            df[df_idx, :T2s] = T2s[iROI]
            df[df_idx, :dT1odm0s] = j[1]
            df[df_idx, :dT1odT1f] = j[2]
            df[df_idx, :dT1odT2f] = j[3]
            df[df_idx, :dT1odTex] = j[4]
            df[df_idx, :dT1odT1s] = j[5]
            df[df_idx, :dT1odT2s] = j[6]
        end
    end
    CSV.write(&quot;$(get_main_path())/jacobian.csv&quot;, df)
else
    df = DataFrame(CSV.File(&quot;$(get_main_path())/jacobian.csv&quot;))
end
show(df; allrows=false, allcols=true)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">225×15 DataFrame
 Row │ seq_name                           seq_type  ROI          m0s      T1f      T2f      Tex        T1s      T2s      dT1odm0s  dT1odT1f  dT1odT2f      dT1odTex  dT1odT1s  dT1odT2s
     │ String                             String7   String15     Float64  Float64  Float64  Float64    Float64  Float64  Float64   Float64   Float64       Float64   Float64   Float64
─────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1 │ IR Stanisz et al.                  IR        WM             0.212     1.84   0.0769  0.0735294    0.34      12.5  -2.10292  0.267415  -0.000110262  1.30037   1.37382    0.000508036
   2 │ IR Stikhov et al.                  IR        WM             0.212     1.84   0.0769  0.0735294    0.34      12.5  -2.28826  0.222543  -0.0506166    0.912075  1.02529   -0.000920414
   3 │ IR Preibisch et al.                IR        WM             0.212     1.84   0.0769  0.0735294    0.34      12.5  -2.46361  0.228864   0.20441      1.52069   1.06454    0.00100851
   4 │ IR Shin et al.                     IR        WM             0.212     1.84   0.0769  0.0735294    0.34      12.5  -2.3551   0.246296  -0.022935     0.743902  1.27175   -1.53697e-5
   5 │ LL Shin et al.                     LL        WM             0.212     1.84   0.0769  0.0735294    0.34      12.5  -2.23983  0.251802  -0.00230623   0.658765  1.39083   -7.00089e-5
   6 │ IR Lu et al.                       IR        WM             0.212     1.84   0.0769  0.0735294    0.34      12.5  -2.22802  0.252726  -0.00395377   0.66974   1.40637   -5.633e-7
   7 │ LL Stikhov et al.                  LL        WM             0.212     1.84   0.0769  0.0735294    0.34      12.5  -2.24     0.18384    0.207381     1.85413   0.707039   0.00407056
   8 │ vFA Stikhov et al.                 vFA       WM             0.212     1.84   0.0769  0.0735294    0.34      12.5  -2.30226  0.298184   0.0182888    2.22977   1.23039    0.0082391
  ⋮  │                 ⋮                     ⋮           ⋮          ⋮        ⋮        ⋮         ⋮         ⋮        ⋮        ⋮         ⋮           ⋮           ⋮         ⋮           ⋮
 219 │ vFA CSMT w/ B1rms = 2uT Teixeira…  vFA       hippocampus    0.097     2.65   0.091   0.0653595    0.376     13.0  -7.14758  0.199928   0.119478     3.20735   0.484602   0.0100345
 220 │ MP2RAGE Marques et al.             MP2RAGE   hippocampus    0.097     2.65   0.091   0.0653595    0.376     13.0  -6.38943  0.349287   1.0598       1.6882    1.25555   -6.6475e-5
 221 │ MPRAGE Wright et al.               MP2RAGE   hippocampus    0.097     2.65   0.091   0.0653595    0.376     13.0  -6.28059  0.394443  -0.00842034   0.53405   1.53763   -9.50526e-5
 222 │ IR EPI Wright et al.               IR        hippocampus    0.097     2.65   0.091   0.0653595    0.376     13.0  -6.28075  0.395435  -0.00386423   0.670863  1.55602    0.000378673
 223 │ IR ad. Reynolds et al.             IR        hippocampus    0.097     2.65   0.091   0.0653595    0.376     13.0  -6.48347  0.376248  -0.0332049    1.16102   1.3979     0.000621703
 224 │ IR sinc Reynolds et al.            IR        hippocampus    0.097     2.65   0.091   0.0653595    0.376     13.0  -6.60535  0.361462  -0.00268402   1.05062   1.3209     0.00289585
 225 │ SR Reynolds et al.                 SR        hippocampus    0.097     2.65   0.091   0.0653595    0.376     13.0  -6.24995  0.4047     0.232175     1.09583   1.62443    0.00010026
                                                                                                                                                                            210 rows omitted</code></pre><h2 id="Figure-1"><a class="docs-heading-anchor" href="#Figure-1">Figure 1</a><a id="Figure-1-1"></a><a class="docs-heading-anchor-permalink" href="#Figure-1" title="Permalink"></a></h2><p>Fig. 1 is a scatter plot and <code>_x</code> ensures the desired alignment along the x-axis and <code>ymax</code> ensures a uniform scaling of the plot:</p><pre><code class="language-julia hljs">_x = Float64.(map(x -&gt; findfirst(isequal(x), unique(df.ROI)), df.ROI))
_x .+= (map(x -&gt; findfirst(isequal(x), sort(unique(df.seq_type))), df.seq_type) .- 3) ./ 8
ymax = maximum([maximum(abs.(df[!, j[i]] .* mean(df[!, p[i]]))) for i ∈ eachindex(j)]) * 1.1</code></pre><pre><code class="language-julia hljs">pall = similar(j, Plots.Plot)
ylabels = [&quot;|∂T₁ᵒ/∂m₀ˢ⋅μ(m₀ˢ)| (s)&quot;, &quot;|∂T₁ᵒ/∂T₁ᶠ⋅μ(T₁ᶠ)| (s)&quot;, &quot;|∂T₁ᵒ/∂T₂ᶠ⋅μ(T₂ᶠ)| (s)&quot;, &quot;|∂T₁ᵒ/∂Tₓ⋅μ(Tₓ)| (s)&quot;, &quot;|∂T₁ᵒ/∂T₁ˢ⋅μ(T₁ˢ)| (s)&quot;, &quot;|∂T₁ᵒ/∂T₂ˢ⋅μ(T₂ˢ)| (s)&quot;]
for id ∈ eachindex(j)
    pall[id] = scatter(_x, abs.(df[!, j[id]] .* mean(df[!, p[id]])),
        group=df.seq_type,
        hover=df.seq_name,
        xticks=id == length(j) ? (1:9, String.(unique(df.ROI))) : (1:9, [&quot;&quot; for _ ∈ 1:9]),
        ylim=(0, ymax),
        ylabel=ylabels[id],
        legend_position=:none,
    )
end
plt = plot(pall..., layout=(6, 1), size=(800, 1500))</code></pre><object type="text/html" data="../../plots/331428549.html" style="width:820px;height:1520px;"></object><p>Derivatives of the observed <code>T₁ᵒ</code> with respect to the 6 MT parameters. I calculated the derivatives for 9 brain regions of interest (ROIs) and for 25 pulse sequences, grouped into different sequence types (cf. legend). Here, WM denotes white matter, CC the corpus callosum, and GM gray matter. The derivatives <code>∂T₁ᵒ/∂pᵢᴹᵀ</code> are normalized by <code>pᵢᴹᵀ</code>, averaged over all ROIs, to allow for a comparison between the parameters.</p><h2 id="Linear-Mixed-model"><a class="docs-heading-anchor" href="#Linear-Mixed-model">Linear Mixed model</a><a id="Linear-Mixed-model-1"></a><a class="docs-heading-anchor-permalink" href="#Linear-Mixed-model" title="Permalink"></a></h2><p>First, we initialize a few empty <code>DataFrame</code> objects that are filled in the for-loop.</p><pre><code class="language-julia hljs">df_pred = DataFrame(
    dT1odm0s_simulated=Vector{Float64}(undef, Nrows),
    dT1odT1f_simulated=Vector{Float64}(undef, Nrows),
    dT1odT2f_simulated=Vector{Float64}(undef, Nrows),
    dT1odTex_simulated=Vector{Float64}(undef, Nrows),
    dT1odT1s_simulated=Vector{Float64}(undef, Nrows),
    dT1odT2s_simulated=Vector{Float64}(undef, Nrows),
    dT1odm0s_predicted=Vector{Float64}(undef, Nrows),
    dT1odT1f_predicted=Vector{Float64}(undef, Nrows),
    dT1odT2f_predicted=Vector{Float64}(undef, Nrows),
    dT1odTex_predicted=Vector{Float64}(undef, Nrows),
    dT1odT1s_predicted=Vector{Float64}(undef, Nrows),
    dT1odT2s_predicted=Vector{Float64}(undef, Nrows),
    color=Vector{Int}(undef, Nrows),
    ROI=Vector{Symbol}(undef, Nrows),
)

r2 = DataFrame()
r2[!, Symbol(&quot;∂T₁ᵒ / ∂pᵢᴹᵀ&quot;)]=Symbol[]
r2[!, Symbol(&quot;μ(|∂T₁ᵒ/∂pᵢᴹᵀ|) ⋅ μ(pᵢᴹᵀ)&quot;)]=Float64[]
r2[!, Symbol(&quot;σ(∂T₁ᵒ/∂pᵢᴹᵀ) / μ(|∂T₁ᵒ/∂pᵢᴹᵀ|)&quot;)]=Float64[]
r2[!, Symbol(&quot;R²(fixed)&quot;)]=Float64[]
r2[!, Symbol(&quot;R²(ROI)&quot;)]=Float64[]
r2[!, Symbol(&quot;R²(seq. type)&quot;)]=Float64[]
r2[!, Symbol(&quot;R²(ind. seq)&quot;)]=Float64[]
r2[!, Symbol(&quot;R²(full)&quot;)]=Float64[]

r2_fixed = DataFrame()
r2_fixed[!, Symbol(&quot;∂T₁ᵒ / ∂pᵢᴹᵀ&quot;)]=Symbol[]
r2_fixed[!, Symbol(&quot;R²(m₀ˢ)&quot;)]=Float64[]
r2_fixed[!, Symbol(&quot;R²(T₁ᶠ)&quot;)]=Float64[]
r2_fixed[!, Symbol(&quot;R²(T₂ᶠ)&quot;)]=Float64[]
r2_fixed[!, Symbol(&quot;R²(Tₓ)&quot;)]=Float64[]
r2_fixed[!, Symbol(&quot;R²(T₁ˢ)&quot;)]=Float64[]
r2_fixed[!, Symbol(&quot;R²(T₂ˢ)&quot;)]=Float64[]
r2_fixed[!, Symbol(&quot;R²(fixed)&quot;)]=Float64[]

fixed_model = DataFrame()
fixed_model[!, Symbol(&quot;∂T₁ᵒ / ∂pᵢᴹᵀ&quot;)]=Symbol[]
fixed_model[!, Symbol(&quot;a₀&quot;)]=Float64[]
fixed_model[!, Symbol(&quot;a(m₀ˢ)&quot;)]=Float64[]
fixed_model[!, Symbol(&quot;a(T₁ᶠ) (1/s)&quot;)]=Float64[]
fixed_model[!, Symbol(&quot;a(T₂ᶠ) (1/s)&quot;)]=Float64[]
fixed_model[!, Symbol(&quot;a(Tₓ) (1/s)&quot;)]=Float64[]
fixed_model[!, Symbol(&quot;a(T₁ˢ) (1/s)&quot;)]=Float64[]
fixed_model[!, Symbol(&quot;a(T₂ˢ) (1/s)&quot;)]=Float64[]
fixed_model[!, Symbol(&quot;m₀ˢ = 0&quot;)]=Float64[]


pall = similar(j, Plots.Plot)
for id ∈ eachindex(j)
    μⱼ = mean(abs.(df[!, j[id]])) * mean(df[!, p[id]])
    cv = std(df[!, j[id]]) / mean(abs.(df[!, j[id]]))

    frm = @formula(derivative ~ 1 + m0s + T1f + T2f + Tex + T1s + T2s + (1 | seq_type) + (1 | seq_name) + (1 | ROI))
    model = fit(MixedModel, term(j[id]) ~ frm.rhs, df)

    pred = sum(param -&gt; model.βs[param] .* df[!, param], Symbol.(frm.rhs[collect(typeof.(frm.rhs) .== Term)]))
    σ²_fixed = var(pred; corrected=false)

    σ²_ROI = model.σs[:ROI][1]^2
    σ²_seqname = model.σs[:seq_name][1]^2
    σ²_seqtype = model.σs[:seq_type][1]^2
    σ²_ϵ = model.σ^2
    σ²_all = σ²_fixed + σ²_ROI + σ²_seqtype + σ²_seqname + σ²_ϵ

    r²_fixed = σ²_fixed / σ²_all
    r²_ROI = σ²_ROI / σ²_all
    r²_seqname = σ²_seqname / σ²_all
    r²_seqtype = σ²_seqtype / σ²_all
    r²_full = (σ²_fixed + σ²_ROI + σ²_seqtype + σ²_seqname) / σ²_all

    fe = fixef(model)
    m0s_intercept = fe[1] + mean(df.T1f) * fe[3] + mean(df.T2f) * fe[4] + mean(df.Tex) * fe[5] + mean(df.T1s) * fe[6] + mean(df.T2s) * fe[7]

    push!(r2, (j[id], μⱼ, cv, r²_fixed, r²_ROI, r²_seqtype, r²_seqname, r²_full))

    Δr² = shapley_regression(df, j[id], p)
    push!(r2_fixed, (j[id], Δr²..., sum(Δr²)))

    push!(fixed_model, (j[id], fe..., m0s_intercept))


    # Plot: simulated vs. full-model prediction
    dlim = maximum(df[!, j[id]]) - minimum(df[!, j[id]])
    xlim = (minimum(df[!, j[id]]) - 0.15dlim, maximum(df[!, j[id]]) + 0.15dlim)

    available_markers = [:circle, :rect, :diamond, :hexagon, :cross, :xcross, :utriangle, :x, :dtriangle]
    unique_ROI = unique(df.ROI)
    label_to_marker = Dict(label =&gt; available_markers[i] for (i, label) in enumerate(unique_ROI))
    markers = [label_to_marker[label] for label in df.ROI]

    pall[id] = scatter(df[!, j[id]], predict(model);
        group=df.seq_type,
        hover=df.seq_name .* &quot;; &quot; .* String.(df.ROI),
        m=markers,
        title = j[id],
        xlabel=id ∈ [5,6] ? &quot;simulated&quot; : &quot;&quot;,
        ylabel=id ∈ [1,3,5] ? &quot;predicted&quot; : &quot;&quot;,
        legend_position=:outerbottomright,
        xlim,
        ylim=xlim
    )

    plot!(pall[id], [xlim...], [xlim...], label=&quot;ideal&quot;, lc=:white, ls=:dash)
end</code></pre><h2 id="Table-1"><a class="docs-heading-anchor" href="#Table-1">Table 1</a><a id="Table-1-1"></a><a class="docs-heading-anchor-permalink" href="#Table-1" title="Permalink"></a></h2><p>Print the results of the mixed effects model fit:</p><pre><code class="language-julia hljs">r2</code></pre><div><div style = "float: left;"><span>6×8 DataFrame</span></div><div style = "clear: both;"></div></div><div class = "data-frame" style = "overflow-x: scroll;"><table class = "data-frame" style = "margin-bottom: 6px;"><thead><tr class = "header"><th class = "rowNumber" style = "font-weight: bold; text-align: right;">Row</th><th style = "text-align: left;">∂T₁ᵒ / ∂pᵢᴹᵀ</th><th style = "text-align: left;">μ(|∂T₁ᵒ/∂pᵢᴹᵀ|) ⋅ μ(pᵢᴹᵀ)</th><th style = "text-align: left;">σ(∂T₁ᵒ/∂pᵢᴹᵀ) / μ(|∂T₁ᵒ/∂pᵢᴹᵀ|)</th><th style = "text-align: left;">R²(fixed)</th><th style = "text-align: left;">R²(ROI)</th><th style = "text-align: left;">R²(seq. type)</th><th style = "text-align: left;">R²(ind. seq)</th><th style = "text-align: left;">R²(full)</th></tr><tr class = "subheader headerLastRow"><th class = "rowNumber" style = "font-weight: bold; text-align: right;"></th><th title = "Symbol" style = "text-align: left;">Symbol</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th></tr></thead><tbody><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">1</td><td style = "text-align: left;">dT1odm0s</td><td style = "text-align: right;">0.556933</td><td style = "text-align: right;">0.440659</td><td style = "text-align: right;">0.964721</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0210201</td><td style = "text-align: right;">0.985741</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">2</td><td style = "text-align: left;">dT1odT1f</td><td style = "text-align: right;">0.680899</td><td style = "text-align: right;">0.329069</td><td style = "text-align: right;">0.661442</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.322802</td><td style = "text-align: right;">0.984244</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">3</td><td style = "text-align: left;">dT1odT2f</td><td style = "text-align: right;">0.00756273</td><td style = "text-align: right;">1.96182</td><td style = "text-align: right;">0.0170527</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.198561</td><td style = "text-align: right;">0.683024</td><td style = "text-align: right;">0.898637</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">4</td><td style = "text-align: left;">dT1odTex</td><td style = "text-align: right;">0.0982651</td><td style = "text-align: right;">0.510041</td><td style = "text-align: right;">0.110739</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.494323</td><td style = "text-align: right;">0.364271</td><td style = "text-align: right;">0.969334</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">5</td><td style = "text-align: left;">dT1odT1s</td><td style = "text-align: right;">0.390455</td><td style = "text-align: right;">0.283929</td><td style = "text-align: right;">0.23283</td><td style = "text-align: right;">0.000234572</td><td style = "text-align: right;">0.0130214</td><td style = "text-align: right;">0.722424</td><td style = "text-align: right;">0.968509</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">6</td><td style = "text-align: left;">dT1odT2s</td><td style = "text-align: right;">0.0475484</td><td style = "text-align: right;">0.984586</td><td style = "text-align: right;">0.0145129</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.63195</td><td style = "text-align: right;">0.263944</td><td style = "text-align: right;">0.910407</td></tr></tbody></table></div><p>This table corresponds to Tab. 1 in the <a href="https://arxiv.org/pdf/TODO">paper</a>. The column <code>μ(|∂T₁ᵒ/∂pᵢᴹᵀ|) ⋅ μ(pᵢᴹᵀ)</code> denotes the mean derivative, normalized by the average parameter, and serves as a measure for the sensitivity of <code>T₁ᵒ</code> to the respective parameter. The column <code>σ(∂T₁ᵒ/∂pᵢᴹᵀ) / μ(|∂T₁ᵒ/∂pᵢᴹᵀ|)</code> denotes the coefficient of variation. The coefficients of determination for the full model <code>R^2(full)</code> is dissected into its components: <code>R^2(full) = R²(fixed) + R^2(ROI) + R^2(seq. type) + R^2(ind. seq)</code>, where <code>R²(fixed)</code> captures all fixed effects, that is, the degree to which variations of the <code>pᵢᴹᵀ</code> between the ROIs explain the derivatives&#39; variability. <code>R^2(ROI)</code> captures the ROI-identifier as a random variable, potentially modeling inter-ROI variations not captured by the linear model of <code>pᵢᴹᵀ</code>. <code>R^2(seq. type)</code> captures the degree to which the sequence type, that is, the groups inversion-recovery, Look-Locker, saturation-recovery, variable flip angle, and MP²RAGE, explains variability of the derivatives, and <code>R^2(ind. seq)</code> captures each sequence by itself.</p><h2 id="Table-2"><a class="docs-heading-anchor" href="#Table-2">Table 2</a><a id="Table-2-1"></a><a class="docs-heading-anchor-permalink" href="#Table-2" title="Permalink"></a></h2><pre><code class="language-julia hljs">r2_fixed</code></pre><div><div style = "float: left;"><span>6×8 DataFrame</span></div><div style = "clear: both;"></div></div><div class = "data-frame" style = "overflow-x: scroll;"><table class = "data-frame" style = "margin-bottom: 6px;"><thead><tr class = "header"><th class = "rowNumber" style = "font-weight: bold; text-align: right;">Row</th><th style = "text-align: left;">∂T₁ᵒ / ∂pᵢᴹᵀ</th><th style = "text-align: left;">R²(m₀ˢ)</th><th style = "text-align: left;">R²(T₁ᶠ)</th><th style = "text-align: left;">R²(T₂ᶠ)</th><th style = "text-align: left;">R²(Tₓ)</th><th style = "text-align: left;">R²(T₁ˢ)</th><th style = "text-align: left;">R²(T₂ˢ)</th><th style = "text-align: left;">R²(fixed)</th></tr><tr class = "subheader headerLastRow"><th class = "rowNumber" style = "font-weight: bold; text-align: right;"></th><th title = "Symbol" style = "text-align: left;">Symbol</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th></tr></thead><tbody><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">1</td><td style = "text-align: left;">dT1odm0s</td><td style = "text-align: right;">0.236289</td><td style = "text-align: right;">0.328903</td><td style = "text-align: right;">0.203157</td><td style = "text-align: right;">0.0683046</td><td style = "text-align: right;">0.0982412</td><td style = "text-align: right;">0.0298259</td><td style = "text-align: right;">0.96472</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">2</td><td style = "text-align: left;">dT1odT1f</td><td style = "text-align: right;">0.244748</td><td style = "text-align: right;">0.0608523</td><td style = "text-align: right;">0.0252796</td><td style = "text-align: right;">0.0522312</td><td style = "text-align: right;">0.176062</td><td style = "text-align: right;">0.102258</td><td style = "text-align: right;">0.66143</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">3</td><td style = "text-align: left;">dT1odT2f</td><td style = "text-align: right;">0.00602466</td><td style = "text-align: right;">0.00203602</td><td style = "text-align: right;">0.000862497</td><td style = "text-align: right;">0.00220685</td><td style = "text-align: right;">0.00370932</td><td style = "text-align: right;">0.00221337</td><td style = "text-align: right;">0.0170527</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">4</td><td style = "text-align: left;">dT1odTex</td><td style = "text-align: right;">0.0082649</td><td style = "text-align: right;">0.0397436</td><td style = "text-align: right;">0.0317466</td><td style = "text-align: right;">0.00488157</td><td style = "text-align: right;">0.00945707</td><td style = "text-align: right;">0.0166449</td><td style = "text-align: right;">0.110739</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">5</td><td style = "text-align: left;">dT1odT1s</td><td style = "text-align: right;">0.0207222</td><td style = "text-align: right;">0.0614811</td><td style = "text-align: right;">0.0516094</td><td style = "text-align: right;">0.0130687</td><td style = "text-align: right;">0.0413631</td><td style = "text-align: right;">0.0445847</td><td style = "text-align: right;">0.232829</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">6</td><td style = "text-align: left;">dT1odT2s</td><td style = "text-align: right;">0.000965823</td><td style = "text-align: right;">0.00507139</td><td style = "text-align: right;">0.0044098</td><td style = "text-align: right;">0.000746721</td><td style = "text-align: right;">0.000482004</td><td style = "text-align: right;">0.00283735</td><td style = "text-align: right;">0.0145131</td></tr></tbody></table></div><p>This table corresponds to Tab. 2 in the <a href="https://arxiv.org/pdf/TODO">paper</a> and analyzes the fixed effects. <code>R²(fixed)</code> is separated into the individual effects with Shapley regression. Note that `R²(fixed) = R²(m₀ˢ) + R²(T₁ᶠ) + R²(T₂ᶠ) + R²(Tₓ) + R²(T₁ˢ) + R²(T₂ˢ).</p><h2 id="Figure-2"><a class="docs-heading-anchor" href="#Figure-2">Figure 2</a><a id="Figure-2-1"></a><a class="docs-heading-anchor-permalink" href="#Figure-2" title="Permalink"></a></h2><pre><code class="language-julia hljs">plt = plot(pall..., layout=(3, 2), size=(800, 1000))</code></pre><object type="text/html" data="../../plots/343013010.html" style="width:820px;height:1020px;"></object><p>Validation of the mixed effects model, where &quot;simulated&quot; denotes the simulated derivatives, and &quot;predicted&quot; the output of the mixed model. The sequence type is here color-coded, while the maker shape identifies the region of interest. Here, WM denotes white matter, CC the corpus callosum, and GM gray matter. The dotted line represents the perfect fit.</p><h2 id="Table-A1"><a class="docs-heading-anchor" href="#Table-A1">Table A1</a><a id="Table-A1-1"></a><a class="docs-heading-anchor-permalink" href="#Table-A1" title="Permalink"></a></h2><pre><code class="language-julia hljs">fixed_model</code></pre><div><div style = "float: left;"><span>6×9 DataFrame</span></div><div style = "clear: both;"></div></div><div class = "data-frame" style = "overflow-x: scroll;"><table class = "data-frame" style = "margin-bottom: 6px;"><thead><tr class = "header"><th class = "rowNumber" style = "font-weight: bold; text-align: right;">Row</th><th style = "text-align: left;">∂T₁ᵒ / ∂pᵢᴹᵀ</th><th style = "text-align: left;">a₀</th><th style = "text-align: left;">a(m₀ˢ)</th><th style = "text-align: left;">a(T₁ᶠ) (1/s)</th><th style = "text-align: left;">a(T₂ᶠ) (1/s)</th><th style = "text-align: left;">a(Tₓ) (1/s)</th><th style = "text-align: left;">a(T₁ˢ) (1/s)</th><th style = "text-align: left;">a(T₂ˢ) (1/s)</th><th style = "text-align: left;">m₀ˢ = 0</th></tr><tr class = "subheader headerLastRow"><th class = "rowNumber" style = "font-weight: bold; text-align: right;"></th><th title = "Symbol" style = "text-align: left;">Symbol</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th></tr></thead><tbody><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">1</td><td style = "text-align: left;">dT1odm0s</td><td style = "text-align: right;">3.27099</td><td style = "text-align: right;">5.54264</td><td style = "text-align: right;">-2.9847</td><td style = "text-align: right;">-39.1503</td><td style = "text-align: right;">61.8731</td><td style = "text-align: right;">-0.68595</td><td style = "text-align: right;">-0.20586</td><td style = "text-align: right;">-4.38218</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">2</td><td style = "text-align: left;">dT1odT1f</td><td style = "text-align: right;">0.22123</td><td style = "text-align: right;">-1.44109</td><td style = "text-align: right;">-0.157866</td><td style = "text-align: right;">3.61564</td><td style = "text-align: right;">-2.01963</td><td style = "text-align: right;">0.831118</td><td style = "text-align: right;">0.0160723</td><td style = "text-align: right;">0.569857</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">3</td><td style = "text-align: left;">dT1odT2f</td><td style = "text-align: right;">0.1658</td><td style = "text-align: right;">-0.376151</td><td style = "text-align: right;">0.0265572</td><td style = "text-align: right;">-1.23998</td><td style = "text-align: right;">-0.130622</td><td style = "text-align: right;">0.0929158</td><td style = "text-align: right;">0.00253391</td><td style = "text-align: right;">0.188097</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">4</td><td style = "text-align: left;">dT1odTex</td><td style = "text-align: right;">1.10669</td><td style = "text-align: right;">1.40698</td><td style = "text-align: right;">0.909191</td><td style = "text-align: right;">-3.20033</td><td style = "text-align: right;">-5.16708</td><td style = "text-align: right;">-2.99036</td><td style = "text-align: right;">-0.019092</td><td style = "text-align: right;">0.928565</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">5</td><td style = "text-align: left;">dT1odT1s</td><td style = "text-align: right;">1.51722</td><td style = "text-align: right;">1.09856</td><td style = "text-align: right;">0.546026</td><td style = "text-align: right;">-2.39964</td><td style = "text-align: right;">-4.95085</td><td style = "text-align: right;">-2.56266</td><td style = "text-align: right;">-0.0181253</td><td style = "text-align: right;">0.862619</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">6</td><td style = "text-align: left;">dT1odT2s</td><td style = "text-align: right;">-0.00133644</td><td style = "text-align: right;">0.00399748</td><td style = "text-align: right;">0.00163344</td><td style = "text-align: right;">-0.0156081</td><td style = "text-align: right;">0.0175875</td><td style = "text-align: right;">0.00170419</td><td style = "text-align: right;">-9.99052e-5</td><td style = "text-align: right;">0.00125829</td></tr></tbody></table></div><p>Coefficients of the fixed effects for each derivative&#39;s mixed model fit, including the intercept <code>a₀</code>. The last column denotes the derivatives assuming <code>m₀ˢ = 0</code> and the mean values for the other parameters. For <code>m₀ˢ = 0</code>, the MT model reduces to the Bloch model, and a perfect statistical model should result in <code>∂T₁ᵒ/∂T₁ᶠ = 1</code> and <code>∂T₁ᵒ/∂Tₓ = ∂T₁ᵒ/∂T₁ˢ = ∂T₁ᵒ/∂T₂ˢ = 0</code>. This is clearly not the case, highlighting the limitations of the mixed-effects model when extrapolating.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../helper_functions/">« Helper functions</a><a class="docs-footer-nextpage" href="../Derivatives_HelperFunctions/">Helper functions for the sensitivity analysis »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Wednesday 17 September 2025 03:38">Wednesday 17 September 2025</span>. Using Julia version 1.11.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
